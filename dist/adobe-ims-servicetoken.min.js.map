{"version":3,"file":"adobe-ims-servicetoken.min.js","sources":["../src/ims.js"],"sourcesContent":["import FormDataImport from \"form-data\";\r\nimport fetchImport from \"node-fetch\";\r\nimport murmurHash3 from \"murmurhash3js\";\r\n\r\nconst hash128 = murmurHash3.x64.hash128,\r\n\ttokens = new Map(),\r\n\tclone = typeof structuredClone === \"function\" ? structuredClone : arg => JSON.parse(JSON.stringify(arg)),\r\n\tFormDataFacade = typeof FormData !== \"undefined\" ? FormData : FormDataImport,\r\n\tfetchFacade = typeof fetch !== \"undefined\" ? fetch : fetchImport;\r\n\r\nexport async function token ({\r\n\turl = \"https://ims-na1.adobelogin.com/ims/token\",\r\n\tgrant_type = \"authorization_code\",\r\n\tclient_id = \"\",\r\n\tclient_secret = \"\",\r\n\tcode = \"\",\r\n\tjwt_token = \"\"\r\n} = {}) {\r\n\tconst key = hash128(`${url}|${client_id}|${grant_type}`);\r\n\tlet result;\r\n\r\n\tif (tokens.has(key) === false) {\r\n\t\tconst form = new FormDataFacade();\r\n\t\tlet res;\r\n\r\n\t\tif (grant_type.length > 0) {\r\n\t\t\tform.append(\"grant_type\", grant_type);\r\n\t\t}\r\n\r\n\t\tform.append(\"client_id\", client_id);\r\n\t\tform.append(\"client_secret\", client_secret);\r\n\r\n\t\tif (code.length > 0) {\r\n\t\t\tform.append(\"code\", code);\r\n\t\t}\r\n\r\n\t\tif (jwt_token.length > 0) {\r\n\t\t\tform.append(\"jwt_token\", jwt_token);\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tres = await fetchFacade(url, {\r\n\t\t\t\tmethod: \"POST\",\r\n\t\t\t\theaders: form.getHeaders(),\r\n\t\t\t\tbody: form\r\n\t\t\t});\r\n\t\t} catch (err) {\r\n\t\t\tres = {\r\n\t\t\t\tok: false,\r\n\t\t\t\tstatusText: err.message || err,\r\n\t\t\t\tjson: async () => {\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\terror: res.statusText,\r\n\t\t\t\t\t\terror_description: err.message\r\n\t\t\t\t\t};\r\n\t\t\t\t},\r\n\t\t\t\ttext: async () => err.message || err\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tconst data = await res.json();\r\n\r\n\t\tif (res.ok) {\r\n\t\t\ttokens.set(key, data.access_token);\r\n\t\t\tresult = clone(data.access_token);\r\n\r\n\t\t\tif (data.expires_in !== void 0) {\r\n\t\t\t\tsetTimeout(() => tokens.delete(key), data.expires_in); // 24hr validity at time of dev\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthrow new Error(`[${res.status}] ${data.error}: ${data.error_description}`);\r\n\t\t}\r\n\t} else {\r\n\t\tresult = clone(tokens.get(key));\r\n\t}\r\n\r\n\treturn result;\r\n}\r\n"],"names":["FormDataImport","fetchImport","murmurHash3","hash128","x64","tokens","Map","clone","structuredClone","arg","JSON","parse","stringify","FormDataFacade","FormData","fetchFacade","fetch","async","token","url","grant_type","client_id","client_secret","code","jwt_token","key","result","has","form","res","length","append","method","headers","getHeaders","body","err","ok","statusText","message","json","error","error_description","text","data","Error","status","set","access_token","expires_in","setTimeout","delete","get"],"mappings":";;;;OAIAA,MAAA,mBAAAC,MAAA,oBAAAC,MAAA,gBAAA,MAAMC,EAAUD,EAAYE,IAAID,QAC/BE,EAAS,IAAIC,IACbC,EAAmC,mBAApBC,gBAAiCA,gBAAkBC,GAAOC,KAAKC,MAAMD,KAAKE,UAAUH,IACnGI,EAAqC,oBAAbC,SAA2BA,SAAWd,EAC9De,EAA+B,oBAAVC,MAAwBA,MAAQf,EAE/CgB,eAAeC,GAAOC,IAC5BA,EAAM,2CAA0CC,WAChDA,EAAa,qBAAoBC,UACjCA,EAAY,GAAEC,cACdA,EAAgB,GAAEC,KAClBA,EAAO,GAAEC,UACTA,EAAY,IACT,IACH,MAAMC,EAAMtB,EAAQ,GAAGgB,KAAOE,KAAaD,KAC3C,IAAIM,EAEJ,IAAwB,IAApBrB,EAAOsB,IAAIF,GAAgB,CAC9B,MAAMG,EAAO,IAAIf,EACjB,IAAIgB,EAEAT,EAAWU,OAAS,GACvBF,EAAKG,OAAO,aAAcX,GAG3BQ,EAAKG,OAAO,YAAaV,GACzBO,EAAKG,OAAO,gBAAiBT,GAEzBC,EAAKO,OAAS,GACjBF,EAAKG,OAAO,OAAQR,GAGjBC,EAAUM,OAAS,GACtBF,EAAKG,OAAO,YAAaP,GAG1B,IACCK,QAAYd,EAAYI,EAAK,CAC5Ba,OAAQ,OACRC,QAASL,EAAKM,aACdC,KAAMP,GAEP,CAAC,MAAOQ,GACRP,EAAM,CACLQ,IAAI,EACJC,WAAYF,EAAIG,SAAWH,EAC3BI,KAAMvB,UACE,CACNwB,MAAOZ,EAAIS,WACXI,kBAAmBN,EAAIG,UAGzBI,KAAM1B,SAAYmB,EAAIG,SAAWH,EAElC,CAED,MAAMQ,QAAaf,EAAIW,OAEvB,IAAIX,EAAIQ,GAQP,MAAM,IAAIQ,MAAM,IAAIhB,EAAIiB,WAAWF,EAAKH,UAAUG,EAAKF,qBAPvDrC,EAAO0C,IAAItB,EAAKmB,EAAKI,cACrBtB,EAASnB,EAAMqC,EAAKI,mBAEI,IAApBJ,EAAKK,YACRC,YAAW,IAAM7C,EAAO8C,OAAO1B,IAAMmB,EAAKK,WAK9C,MACEvB,EAASnB,EAAMF,EAAO+C,IAAI3B,IAG3B,OAAOC,CACR,QAAAR"}